{% extends "base.html" %}
{% load static %}

{% block content %}
<head>
    <title>Model training</title>
</head>

<style>
.container-table {
  --bs-gutter-x: 1.5rem;
  --bs-gutter-y: 0;
  width: 750px;
  padding-right: calc(var(--bs-gutter-x) * 0.5);
  padding-left: calc(var(--bs-gutter-x) * 0.5);
  margin-right: auto;
  margin-left: auto;
  margin-top: -40px;
}

.fixed_header {
  width: 750px;
  table-layout: auto;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  margin-top: -40px;
}
.fixed_header tbody {
  display: block;
  width: 100%;
  overflow: auto;
  height: 190px;
}
.fixed_header thead tr {
  display: block;
}
.fixed_header thead {
  background: black;
  color: #fff;
}
.fixed_header th,
.fixed_header td {
  padding: 5px;
  text-align: center;
  width: 200px;
}
.collapsible {
background-color: black;
color: #fff;
cursor: pointer;
padding: 18px;
width: 750px;
margin-left: auto;
margin-right: auto;
border: none;
text-align: center;
outline: none;
font-size: 15px;
}
.active, .collapsible:hover {
background-color: #424649;
}
.content {
padding: 0 18px;
display: none;
overflow: hidden;
background-color: #fff;
}
.table-sortable th {
    cursor: pointer;
}

.table-sortable .th-sort-asc::after {
    content: "\25b4";
}

.table-sortable .th-sort-desc::after {
    content: "\25be";
}

.table-sortable .th-sort-asc::after,
.table-sortable .th-sort-desc::after {
    margin-left: 5px;
}

.table-sortable .th-sort-asc,
.table-sortable .th-sort-desc {
    background: rgba(0, 0, 0, 0.1);
}

</style>

<body class="d-flex flex-column">
    <!-- Alert for error messages if uploding file had wrong format -->
    {% if tr_error_messages %}
    <div class="container">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Error!</strong> The following issue(s) occurred:
                {% for tr_error_message in tr_error_messages %}
                    {{ tr_error_message }}
                {% endfor %}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
    {% endif %}
    <main class="flex-shrink-0">
        <header class="py-5">
            <div class="container px-5">
                <div class="row justify-content-center">
                    <div class="col-lg-8 col-xxl-6">
                        <div class="text-center my-5">
                            <h1 class="fw-bolder mb-3">History of model training</h1>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="container-table">
            <div class="row">
                <table class="fixed_header table-sortable">
                    <thead>
                        <tr>
                            <th>Model ID</th>
                            <th>Date of training</th>
                            <th>Training accuracy</th>
                            <th>Testing accuracy</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tfoot>
                        <tr>
                        <th colspan='5'>
                            <a data-toggle="collapse" class="collapse" href="#collapsableWindow">Re-train model</a>
                        </th>
                        </tr>
                    </tfoot>
                    <tbody>
                        {% for training in training_list %}
                        <tr>
                            <td data-title='Model ID'> {{ training.model_id }} </td>
                            <td data-title='Date of training'> {{ training.training_date }} </td>
                            <td data-title="Training accuracy"> {{ training.training_accuracy }}% </td>
                            <td data-title="Testing accuracy"> {{ training.testing_accuracy }}% </td>
                            <td class='deploy'>
                                {% if training.is_deployed %}
                                    <a class='btn btn-dark' href='#'>Deploy</a>
                                {% else %}
                                    <a class='btn btn-success' href='#'>Deployed</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot>
                        <tr>
                        <th colspan='5'>
                            <a data-toggle="collapse" class="collapse" href="#collapsableWindow">Re-train model</a>
                        </th>
                        </tr>
                    </tfoot>
                </table>
                <button type="submit" class="collapsible">Retrain Model</button>                
                <div class="content">
                    <div class="upload_frame">
                        <label for="input-file" id="drop_area">
                            <input type="file" accept="mp4" id="input-file" hidden />
                        <div id="img_view">
                            <img src="{% static 'assets/upload.png' %}">
                                <p>Drag and drop file here,<br>or<br><a href="#" id="file-browser">browse</a> your computer.</p>
                        </div>
                        </label>
                    </div>
                    <form id="retrain-form" method="post" action="{% url 'training' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-dark">Retrain Model</button>
                    </form>
                </div> 
            </div>
        </div>
    </main>
    <script src="{% static 'js/training_scripts.js'%}"></script>
    <script>
        document.getElementById('retrain-form').addEventListener('submit', function (event) {
            event.preventDefault();

            // Show "Retraining..." notification
            showNotification('Retraining in progress...', 'info');

            fetch(this.action, {
                method: this.method,
                body: new FormData(this),
                headers: {
                    'X-CSRFToken': document.getElementsByName('csrfmiddlewaretoken')[0].value
                }
            })
            .then(response => response.text())
            .then(result => {
                // Hide the previous notification
                hideNotification();

                // Show success 
                showNotification('Retraining successful!', 'success');

                console.log('Result:', result);
            })
            .catch(error => {
                // Hide the previous notification
                hideNotification();

                // Show error notification
                showNotification('Error during retraining!', 'error');
                console.error('Error:', error);
            });
        });

        function showNotification(message, type) {
            alert(message);
        }

        function hideNotification() {
            // Add if needed
        }
    </script>

</body>
{% endblock %}  
